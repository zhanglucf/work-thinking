==几乎都是理论性的东西，没办法，死记硬背。。。==

# JVM的逻辑内存模型

![jvm内存模型详解记录](../images/Snipaste_2021-07-16_18-40-49.png)

# **程序计数器**

**是什么**：　==程序计数器 是一个记录着当前线程所执行的字节码的行号指示器==。

**为什么用**：

> 1. JVM的多线程是通过==CPU时间片轮转算法==来实现的。
>
> 2. 某个线程在执行过程中可能会因为==时间片==耗尽而被==挂起==，而另一个线程获取到时间片开始执行。
>
> 3. 当被挂起的线程重新获取到时间片的时候，它要想从被挂起的地方继续执行，就必须知道它上次执行到哪个位置，
>
>    在JVM中，通过程序计数器来记录某个线程的字节码执行位置。

**特点**

> 1. 线程隔离性，每个线程工作时都有属于自己的独立计数器。
>
> 2. 执行java方法时，程序计数器是有值的，且记录的是正在执行的字节码指令的地址（参考上一小节的描述）。
>
> 3. 执行native本地方法时，程序计数器的值为空（Undefined）
>4. 唯一一个在java虚拟机规范中没有规定任何OutOfMemoryError的区域。

# **Java 虚拟机栈**

> 启动一个线程，程序调用函数，栈帧被压入栈中，函数调用结束，相应的是栈帧的出栈。
>
> **栈帧**的组成部分：
>
> - **局部变量表**：存放的是函数的入参，以及局部变量。
>
> - **操作数栈**：存放调用过程中的计算结果的临时存放区域。
>
> - **帧数据区**：存放的是异常处理表和函数的返回，访问常量池的指针。
>
> 存在的`Error`列举：
>
> - `StackOverflowError`  如果设置了VM Stack的大小-Xss,当方法的调用过深，导致栈的大小不足时抛出。
> - `OutOfMemoryError`  如果没有指定VM Stack的大小，动态扩容时申请不到足够的内存时抛出

![jvm内存模型详解记录](../images/Snipaste_2021-07-16_18-39-24.png)

# **本地方法栈**

> 与虚拟机栈作用相似，只不过本地方法栈是为虚拟机使用到的Native方法服务

# **Java 堆**

> 对于Java应用程序来说，Java 堆 (Java Heap)是虚拟机所管理的内存中最大的一块。
>
> Java 堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。
>
> 此内存区域的唯一目的就是存放对象实例，Java 世界里“几乎”所有的对象实例都在这里分配内存。
>
> Java 堆是垃圾收集器管理的内存区域，因此也常被称为“GC 堆”。

# **方法区**

> 对于HostSpot虚拟机，方法区又被称为永久代（Parmanent Gen）。其实是永久代来实现方法区而已。
>
> jdk1.7的版本中，已经将原本放在永久代的字符串常量池移走。
>
> 所有线程共享的内存区域,保存系统的类信息，比如，常量、静态变量、编译器
>
> jdk1.6和jdk1.7方法区可以理解为永久区。
>
> jdk1.8已经将方法区取消，替代的是==元数据区==,使用参数-XX:MaxMetaspaceSzie设定大小，这是一块堆外的直接内存
>

# 其他拓展

**运行时常量池**

> 运行时常量池（Runtime Constant Pool），它是方法区的一部分。
>
> 用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后存放到常量池中。
>
> Java语言并不要求常量一定只能在编译期产生，运行期间也可能产生新的常量，这些常量被放在运行时常量池中。
>
> 这里所说的常量包括：基本类型包装类和String

**直接内存**

> 直接内存（Direct Memory）就是**Java堆外内存**
>
> 在JDK 1.4中新加入了NIO（New Input/Output）类，引入了一种基于通道（Channel）与缓冲区（Buffer）的I/O方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在Java堆和Native堆中来回复制数据。

# 总结

>| 名称                      | 是否线程共享       | 作用                           | 配置                                                | Error                   |
>| ------------------------- | ------------------ | ------------------------------ | --------------------------------------------------- | ----------------------- |
>| Methed Area               | :white_check_mark: | 静态变量、常量、类的加载信息   | ~~-XX:PermSize -XX:MaxPermSize -XX:MaxMetaspaceSzie | OOM                     |
>| Stack                     | :white_check_mark: | 对象实例                       | -Xmx  -Xms -Xmn                                     | OOM                     |
>| Computer Counter Register | ❌                  | 字节码行号指示器               |                                                     | /                       |
>| VM Stack                  | ❌                  | 局部变量表、操作数栈、帧数据区 | -XSs                                                | StackOverFlowError  OOM |
>| Native Method Stack       | ❌                  | 调用本地Native方法库           |                                                     |                         |



