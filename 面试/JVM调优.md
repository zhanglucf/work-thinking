## JVMçš„å‚æ•°ç±»å‹

> - [x] æ ‡é…å‚æ•°
>    - [x] java -version
>    - [x] java -help
> - [x] xå‚æ•°ï¼ˆäº†è§£ï¼‰
>   - [x] -Xcompï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨å°±ç¼–è¯‘æˆæœ¬åœ°ä»£ç 
>   - [x] -Xintï¼šè§£é‡Šæ‰§è¡Œ
> - [x] xxå‚æ•°
>   - [x] Booleanç±»å‹ 
>   			  -XX:+æˆ–è€…-æŸä¸ªå±æ€§å€¼   +è¡¨ç¤ºå¼€å¯  -è¡¨ç¤ºå…³é—­    -XXï¼š-PrintGCDetails / -XX: +PrintGCDetails
>   - [x] KVè®¾å€¼ç±»å‹
>   		  -XX:å±æ€§key=å±æ€§å€¼value   -XX:MetaspaceSize=128m/-XX:MaxTenuringThreadhold=15
>   - [x] jinfoä¸¾ä¾‹ï¼Œå¦‚ä½•æŸ¥çœ‹å½“å‰è¿è¡Œç¨‹åºçš„é…ç½®
>



## è¯·é—®å¦‚ä½•ç›˜ç‚¹æŸ¥çœ‹jvmç³»ç»Ÿé»˜è®¤å€¼ï¼Ÿ

>    ==**æ‰“å°JVMæ‰€æœ‰çš„é»˜è®¤å‚æ•°è®¾ç½®**==
>
>      ```shell
>      java -XX:+PrintFlagsInitial
>      ```
>    ==**æ‰“å°JVMæœ€ç»ˆå€¼**==   
>
>      > å¦‚æœæŸä¸ªé»˜è®¤å€¼è¢«æ–°å€¼è¦†ç›–ï¼Œæ˜¾ç¤ºæ–°å€¼
>      >
>      > :=   ä»£è¡¨ä¿®æ”¹è¿‡
>    ```shell
>    java -XX:+PrintFlagsFinal -version
>    ```
>
>    ==**å¦‚ä½•ä¿®æ”¹JVMå‚æ•°**==
>
>    > :rage: æ³¨æ„ ==java -XX:+PrintFlagsFinal== -XX:MetaspaceSize=512m ==-version==  é«˜äº®çš„éƒ¨åˆ†ä¸å¯ä»¥çœç•¥
>      >
>      > :warning:     è¸©è¿‡çš„å‘ï¼šæœ€å¼€å§‹çœ‹åˆ°è¿™ä¸ªè®¾ç½®å‚æ•°çš„å‘½ä»¤æ—¶ï¼Œç†æ‰€å½“ç„¶çš„ä»¥ä¸ºä¸Šé¢çš„è¯­å¥å¾ˆç½—å—¦ï¼Œ
>      >
>      > â€‹     è®¤ä¸º` java  -XX:MetaspaceSize=512m` å¯ä»¥è®¾ç½®å‚æ•°ï¼Œå…¶å®æ˜¯ä¸å¯ä»¥çš„ã€‚:angry:
>
>      ```shell
>      java -XX:+PrintFlagsFinal -XX:MetaspaceSize=512m -version
>      ```
>
>      > ä¸Šé¢åªæ˜¯åˆ—ä¸¾äº†`MetaspaceSize`å…¶ä»–çš„å‚æ•°å‚è€ƒè¿™ä¸ªå¯ä»¥è®¾ç½®ï¼Œæ¯”å¦‚ä¸‹é¢
>
>      ```shell
>      java -XX:+PrintFlagsFinal -XX:MaxTenuringThreshold=13 -version
>      ```
>
>    **==æŸ¥çœ‹é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨    æ˜¯æ‰“å°é‚£äº›è¢«æ–°å€¼è¦†ç›–çš„é¡¹==** :star:
>
>    ```shell
>    java -XX:+PrintCommandLineFlags -version
>    ```
>
>    ==**æŸ¥çœ‹è¿è¡Œçš„JavaæœåŠ¡çš„JVMå‚æ•°**==
>
>    > **æŸ¥çœ‹è¿›ç¨‹å·**
>
>    ```shell
>    jps -l
>    ```
>
>    > **æ ¹æ®è¿›ç¨‹å·æŸ¥çœ‹JVMæŒ‡å®šå‚æ•°ä¿¡æ¯**
>
>    ```shell
>    jinfo -flag MetaspaceSize 1000
>    ```
>
>    > **æ ¹æ®è¿›ç¨‹å·æŸ¥çœ‹JVMæ‰€æœ‰å‚æ•°ä¿¡æ¯**
>
>    ```shell
>    jinfo -flags 1000
>    ```



## Xms  Xmxå±äºå“ªä¸€ç§å‚æ•°ç±»å‹ï¼Ÿ

> Xms  Xmxå…¶å®ç±»ä¼¼æ•°æ®åº“åˆ«åï¼ŒXmsç­‰ä»·äºInitialHeapSize  Xmxç­‰ä»·äºMaxHeapSize

## GCåƒåœ¾å›æ”¶ä¸­çš„åƒåœ¾æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ

> ç®€å•çš„æ¥è¯´æ˜¯å†…å­˜ä¸­å·²ç»ä¸å†ä½¿ç”¨åˆ°çš„ç©ºé—´å°±æ˜¯åƒåœ¾

## å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦åº”è¯¥å›æ”¶ï¼Ÿ

> å¼•ç”¨è®¡æ•°æ³•
>
> :white_check_mark: ==æšä¸¾æ ¹èŠ‚ç‚¹å¯è¾¾æ€§åˆ†æï¼ˆGCRoots)==

## JAVAä¸­å¯ä»¥ä½œä¸ºGCRootsçš„å¯¹è±¡æœ‰å“ªäº›ï¼Ÿ

>:white_check_mark: è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ï¼ˆå±€éƒ¨å˜é‡ï¼‰
>
>:white_check_mark: æ–¹æ³•åŒºçš„é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
>
>:white_check_mark: æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
>
>:white_check_mark: æœ¬åœ°æ–¹æ³•æ ˆä¸­nativeæ–¹æ³•å¼•ç”¨çš„å¯¹è±¡

## ä½ å·¥ä½œä¸­ç”¨çš„jvmå¸¸ç”¨åŸºæœ¬é…ç½®å‚æ•°æœ‰å“ªäº›ï¼Ÿ

> :white_check_mark: å †åˆå§‹çš„å¤§å°ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64 
>
> ```shell
> -Xms  
> -XX:InitialHeapSize
> ```
>
> :white_check_mark: å †å†…å­˜æœ€å¤§å€¼ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4
>
> ```shell
> -Xmx
> -XX:MaxHeapSize
> ```
>
> :white_check_mark: è®¾ç½®å•ä¸ªçº¿ç¨‹==æ ˆ==çš„å¤§å°ï¼Œä¸€èˆ¬ä¸º512k~1024k  
>
> ```shell
> -Xss 
> -XX:ThreadStackSize
> ```
>
> :white_check_mark: è®¾ç½®æ–°ç”Ÿä»£å¤§å°  ä¸€èˆ¬ä½¿ç”¨é»˜è®¤å€¼å³å¯
>
> ```shell
> -Xmn
> ```
>
> :white_check_mark: å…ƒç©ºé—´å¤§å° 
>
> ```shell
> -XX:MatespaceSize
> ```
>
> æŸ¥çœ‹å…ƒç©ºé—´å¤§å°  15908 æ˜¯javaæœåŠ¡è¿›ç¨‹çš„ID
>
> ```shell
> jinfo -flag MetaspaceSize 15908
> ```
>
> > å…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­è€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°å—åˆ°	æœ¬åœ°å†…å­˜çš„é™åˆ¶
> >
>



```shell
-XX:+PrintCommandLineFlags
```

> æˆ‘ä»¬åœ¨ideaå·¥å…·çš„VM Optionsä¸­é…ç½®-XX:+PrintCommandLineFlagsï¼Œå¯åŠ¨é¡¹ç›®å¯ä»¥çœ‹åˆ°
>
> ```shell
> -XX:-BytecodeVerificationLocal 
> -XX:-BytecodeVerificationRemote 
> -XX:InitialHeapSize=265729216 
> -XX:+ManagementServer 
> -XX:MaxHeapSize=4251667456 
> -XX:+PrintCommandLineFlags 
> -XX:TieredStopAtLevel=1 
> -XX:+UseCompressedClassPointers 
> -XX:+UseCompressedOops
> -XX:-UseLargePagesIndividualAllocation 
> -XX:+UseParallelGC   # å¹¶è¡Œåƒåœ¾å›æ”¶å™¨
> ```
>
> æˆ‘ä»¬åœ¨ideaå·¥å…·çš„VM Optionsä¸­é…ç½®å¦‚ä¸‹é…ç½®ï¼š
>
> ```shell
> -Xms128m  -Xmx4096m -Xss1024k -XX:MetaspaceSize=512m -XX:+PrintCommandLineFlags -XX:+PrintGCDetails -XX:+UseSerialGC
> ```
>
> å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š
>
> ```shell
> -XX:-BytecodeVerificationLocal 
> -XX:-BytecodeVerificationRemote 
> -XX:InitialHeapSize=134217728 
> -XX:+ManagementServer 
> -XX:MaxHeapSize=4294967296 
> -XX:MetaspaceSize=536870912 
> -XX:+PrintCommandLineFlags 
> -XX:+PrintGCDetails 
> -XX:ThreadStackSize=1024
> -XX:TieredStopAtLevel=1 
> -XX:+UseCompressedClassPointers 
> -XX:+UseCompressedOops 
> -XX:-UseLargePagesIndividualAllocation 
> -XX:+UseSerialGC #ä¸²è¡Œåƒåœ¾å›æ”¶å™¨
> ```



:white_check_mark: :star: æ‰“å°åƒåœ¾å›æ”¶çš„ç»†èŠ‚æ—¥å¿—

```shell
-XX:+PrintGCDetails
```

> å¯ä»¥çœ‹åˆ°è¾“å‡ºæ—¥å¿— 

```shell
Heap
 PSYoungGen      total 75776K, used 7805K [0x000000076b800000, 0x0000000770c80000, 0x00000007c0000000)
  eden space 65024K, 12% used [0x000000076b800000,0x000000076bf9f6b0,0x000000076f780000)
  from space 10752K, 0% used [0x0000000770200000,0x0000000770200000,0x0000000770c80000)
  to   space 10752K, 0% used [0x000000076f780000,0x000000076f780000,0x0000000770200000)
 ParOldGen       total 173568K, used 0K [0x00000006c2800000, 0x00000006cd180000, 0x000000076b800000)
  object space 173568K, 0% used [0x00000006c2800000,0x00000006c2800000,0x00000006cd180000)
 Metaspace       used 3961K, capacity 4628K, committed 4864K, reserved 1056768K
  class space    used 435K, capacity 464K, committed 512K, reserved 1048576K
```

æ¼”ç¤ºå¦‚ä½•è§¦å‘OutOfMemoryError

```shell
-Xms10m -Xmx10m -XX:+PrintGCDetails
```

```java
    public static void main(String[] args) throws InterruptedException {
        byte[] byteArray = new byte[50*1024*1024];
    }
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```shell
[GC (Allocation Failure) [PSYoungGen: 2048K->504K(2560K)] 2048K->865K(9728K), 0.0006088 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[GC (Allocation Failure) [PSYoungGen: 2552K->504K(2560K)] 2913K->1178K(9728K), 0.0009785 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[GC (Allocation Failure) [PSYoungGen: 1010K->5 04K(2560K)] 1685K->1282K(9728K), 0.0005856 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[GC (Allocation Failure) [PSYoungGen: 504K->504K(2560K)] 1282K->1330K(9728K), 0.0006516 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[Full GC (Allocation Failure) [PSYoungGen: 504K->0K(2560K)] [ParOldGen: 826K->1026K(7168K)] 1330K->1026K(9728K), [Metaspace: 3956K->3956K(1056768K)], 0.0082664 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] 1026K->1026K(9728K), 0.0005166 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 

[Full GC (Allocation Failure) [PSYoungGen: 0K->0K(2560K)] [ParOldGen: 1026K->1004K(7168K)] 1026K->1004K(9728K), [Metaspace: 3956K->3956K(1056768K)], 0.0218341 secs] [Times: user=0.16 sys=0.00, real=0.02 secs] 
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
	at com.jvm.VMFlags.main(VMFlags.java:9)
Heap
 PSYoungGen      total 2560K, used 61K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)
  eden space 2048K, 3% used [0x00000000ffd00000,0x00000000ffd0f5f8,0x00000000fff00000)
  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)
  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)
 ParOldGen       total 7168K, used 1004K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)
  object space 7168K, 14% used [0x00000000ff600000,0x00000000ff6fb388,0x00000000ffd00000)
 Metaspace       used 3985K, capacity 4628K, committed 4864K, reserved 1056768K
  class space    used 438K, capacity 464K, committed 512K, reserved 1048576K
```

å‚æ•°è¯´æ˜ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../images/20190422000521294.png)



![image-20210720172722020](../images/image-20210720172722020.png)



:white_check_mark: é…ç½®æ–°ç”Ÿä»£ä¸­Edenã€SO1ã€SO2åŒºçš„æ¯”ä¾‹

```shell
-XX:SurvivorRatio
```

> â€‹	 é»˜è®¤ -XX:SurvivorRatio=8ï¼ŒEden:SO1:SO2=8:1:1
>
> â€‹     å¦‚æœé…ç½®æˆ4ï¼Œæ„æ€æ˜¯Eden:SO1:SO2=4:1:1

:white_check_mark:é…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£çš„æ¯”ä¾‹

```shell
-XX:NewRatio
```

> é»˜è®¤æ˜¯ -XX:NewRatio =2 æ–°ç”Ÿä»£1 è€å¹´ä»£2   ç¾[ËˆreÉªÊƒioÊŠ]
>
> ä¸€èˆ¬ä¸ç”¨å»ä¿®æ”¹è¿™ä¸ªå‚æ•°

:white_check_mark:è®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„

```shell
-XX:MaxTenuringThreshold
```

>  é»˜è®¤-XX:MaxTenuringThreshold=15  æ˜¯æœ‰èŒƒå›´çš„æˆ‘ä»¬ä¿®æ”¹åªèƒ½åœ¨0-15ä¹‹é—´



![](../images/src=http___image.codes51.com_Article_image_20170419_20170419000548_1133.jpg&refer=http___image.codes51.jpg)



------

![est.cn_info_u](../images/est.cn_info_u.jpg)



## å››ç§å¼•ç”¨

![image-20210720192116761](../images/image-20210720192116761.png)

------

![img](../images/upload-images.jianshu.io&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg)

:one: å¼ºå¼•ç”¨-StrongReference

> è¿™æ˜¯javaä¸­æœ€å¸¸è§çš„å¼•ç”¨æ–¹å¼ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«ä¸€ä¸ªæˆ–ä¸€ä¸ªä»¥ä¸Šçš„å¼•ç”¨å˜é‡æ‰€å¼•ç”¨æ—¶ï¼Œå®ƒä¸å¯èƒ½è¢«ç³»ç»Ÿåƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶

ä½¿ç”¨åœºæ™¯ï¼šä¾‹å¦‚æ•°ç»„

:two: è½¯å¼•ç”¨-SoftReference

> å¯¹äºåªæœ‰è½¯å¼•ç”¨çš„å¯¹è±¡è€Œè¨€ï¼Œå½“ç³»ç»Ÿå†…å­˜ç©ºé—´è¶³å¤Ÿæ—¶ï¼Œå®ƒä¸ä¼šè¢«ç³»ç»Ÿå›æ”¶ï¼›å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šè¢«å›æ”¶

**ä½¿ç”¨åœºæ™¯ï¼šåˆ›å»ºç¼“å­˜**

:three: å¼±å¼•ç”¨-WeakReference

> å¯¹äºåªæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡è€Œè¨€ï¼Œå½“ç³»ç»Ÿåƒåœ¾å›æ”¶æœºåˆ¶è¿è¡Œæ—¶ï¼Œä¸ç®¡ç³»ç»Ÿå†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œè¯¥å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ä¸€å®šä¼šè¢«å›æ”¶ã€‚

**ä½¿ç”¨åœºæ™¯ï¼šWeakHashMapç±»ä¸­çš„key**  `ThreadLocal`ç±»ä¸­ä¹Ÿæ˜¯ç”¨äº†å¼±å¼•ç”¨


:four: è™šå¼•ç”¨-PhantomReference

> å¦‚æœä¸€ä¸ªå¯¹è±¡åªæœ‰ä¸€ä¸ªè™šå¼•ç”¨æ—¶ï¼Œé‚£ä¹ˆå®ƒå’Œæ²¡æœ‰å¼•ç”¨çš„æ•ˆæœå¤§è‡´ç›¸åŒ

**ä½¿ç”¨åœºæ™¯ï¼šç”¨äºå¯¹è±¡é”€æ¯å‰çš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚è¯´èµ„æºé‡Šæ”¾ç­‰**

 

:dolphin:  :whale: ğŸŸ  :four_leaf_clover::bell: :pushpin:âœï¸ ğŸ“—ğŸš© â–¶ï¸ ğŸ”· âœ”ï¸âœ–ï¸ âŒ ğŸ”°

## OOMä½ äº†è§£å¤šå°‘ï¼Ÿ

>ğŸ”·`java.lang.StackOverflowError` 
>
>ğŸ”·`java.lang.OutOfMemoryError: Java heap space`   
>
>> âœï¸ å †OOM  è§£å†³æ–¹æ³•ï¼š å¢å¤§Xmxå€¼ ä½¿ç”¨MATï¼ŒJProfileç­‰å·¥å…·è¿›è¡Œä»£ç åˆ†æä¸ä¼˜åŒ–
>
>ğŸ”·`java.lang.OutOfMemoryError: Direct buffer memory` 
>
>> âœï¸ ç›´æ¥å†…å­˜OOM å¢å¤§MaxDirectMemorySizeçš„å€¼
>
>> ```java
>>     /**
>>      *  -Xmx1g -XX:+PrintGCDetails -XX:MaxDirectMemorySize=100m
>>      */
>>     public static void main(String[] args) {
>>         List<ByteBuffer> byteBuffers = new ArrayList<>();
>>         for (int i = 0; i < 2048; i++) {
>>             System.out.println(i);
>>             byteBuffers.add(ByteBuffer.allocateDirect(1024 * 1024));
>>         }
>>     }
>> ```
>
>ğŸ”·`OutOfMemoryError: GC overhead limit exceeded`     ç¾[ÉªkËˆsiËdÉªd]     ğŸ“—å¤§æ–‡ä»¶å¯¼å‡º**XSSFWorkbook** ä¼šå¯¼è‡´è¿™ä¸ªé—®é¢˜ã€‚ç”¨**SXSSFWorkbook** æ›¿ä»£
>
>```
>Java VisuaalVM  å¹¶åœ¨OOMçš„æ—¶å€™è·å–äº†dumpæ–‡ä»¶ 
>apacheçš„POIé¡¹ç›®æ¨å‡ºäº†ä¸€ä¸ªå®ç°å¤§æ•°æ®é‡çš„æµå¼ç‰ˆæœ¬XSSFWorkbookï¼Œä¹Ÿç§°ä¹‹ä¸ºSXSSFWorkbookï¼Œå®ƒå…è®¸äº†æˆ‘ä»¬ç¼–å†™éå¸¸å¤§çš„æ–‡ä»¶è€Œä¸ä¼šè€—å°½å†…å­˜ï¼Œå› ä¸ºåœ¨ä»»ä½•æ—¶å€™åªæœ‰è¡Œçš„å¯é…ç½®éƒ¨åˆ†ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¾‹å¦‚åˆå¹¶åŒºåŸŸï¼Œæ³¨é‡Šç­‰ã€‚
>```
>
>
>
>>>âœï¸å¦‚æœ`Java`è¿›ç¨‹èŠ±è´¹`98%`ä»¥ä¸Šçš„æ—¶é—´æ‰§è¡Œ`GC`ï¼Œå¹¶ä¸”æ¯æ¬¡åªæœ‰ä¸åˆ°`2%`çš„å †è¢«æ¢å¤ï¼Œåˆ™`JVM`æŠ›å‡ºæ­¤é”™è¯¯ã€‚
>
>>```java
>>/**
>> * -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:MaxDirectMemorySize=5m
>> */
>>public static void main(String[] args) {
>>    int i = 0;
>>    List<String> list = new ArrayList<>();
>>    try {
>>        while (true) {
>>            list.add(String.valueOf(i + UUID.randomUUID().toString()).intern());
>>        }
>>    } catch (Exception e) {
>>        System.out.println(i);
>>        e.printStackTrace();
>>    }
>>}
>>```
>
>ğŸ”·`java.lang.OutOfMemoryError: unable to create new native thread`
>
>> åˆ›å»ºäº†å¤ªå¤šçš„çº¿ç¨‹ï¼Œè€Œèƒ½åˆ›å»ºçš„çº¿ç¨‹æ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œå¯¼è‡´äº†å¼‚å¸¸çš„å‘ç”Ÿ
>
>> ç³»ç»Ÿå…è®¸ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸åŒçš„ç³»ç»Ÿè¿™ä¸ªé™åˆ¶ä¸åŒã€‚ä¾‹å¦‚Linuxç³»ç»Ÿç³»ç»Ÿé»˜è®¤å…è®¸å•ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºçš„çº¿ç¨‹æ•°æ˜¯1024ä¸ª
>
>> å¦‚æœåº”ç”¨åˆ›å»ºçš„çº¿ç¨‹æ•°å¤§äºè¿™ä¸ªæ•°ï¼Œå°±ä¼šæŠ¥OOM unable to create new native thread;
>
>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼š
>
>> é™ä½åº”ç”¨ç¨‹åºçš„çº¿ç¨‹æ•°é‡ï¼Œåˆ†æåº”ç”¨æ˜¯å¦çœŸçš„éœ€è¦åˆ›å»ºè¿™ä¹ˆå¤šçš„çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯è¦åšè°ƒæ•´
>
>> å¯¹äºæœ‰çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œç¡®å®éœ€è¦åˆ›å»ºå¾ˆå¤šçš„çº¿ç¨‹ï¼Œå¯ä»¥ä¿®æ”¹æœåŠ¡å™¨çš„é…ç½®
>
>> ```shell
>> [root@VM-0-16-centos limits.d]# ulimit -u
>> 7269
>> [root@VM-0-16-centos limits.d]# pwd
>> /etc/security/limits.d
>> [root@VM-0-16-centos limits.d]# vim 20-nproc.conf
>> ```
>
>> ![image-20210721144631978](../images/image-20210721144631978.png)



## å­—ç¬¦ä¸²å¸¸é‡æ± åˆ°åº•æ˜¯åœ¨æ–¹æ³•åŒºã€è¿˜æ˜¯å †é‡Œã€è¿˜æ˜¯å…ƒç©ºé—´é‡Œé¢å‘¢ï¼Ÿ

> è¿™ä¸ªå’Œjdkçš„ç‰ˆæœ¬æœ‰å…³
>
> åœ¨1.6ç‰ˆæœ¬ï¼Œæ–¹æ³•åŒºç”±  **æ°¸ä¹…ä»£** ï¼ˆPermGenï¼‰å®ç°ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨æ°¸ä¹…ä»£
>
> åœ¨1.7ç‰ˆæœ¬ **æ–¹æ³•åŒºç”±æ°¸ä¹…ä»£å’Œå †å®ç°**   ï¼Œ å¸¸é‡æ± å’Œé™æ€å˜é‡æ”¾å…¥äº†å †ä¸­
>
> åœ¨1.8ç‰ˆæœ¬ æŠŠæ°¸ä¹…ä»£åˆ ï¼Œé™¤ä½¿ç”¨å…ƒç©ºé—´ï¼Œä¹Ÿå°±æ˜¯**æ–¹æ³•åŒºç”±å…ƒç©ºé—´(ç±»ä¿¡æ¯)å’Œå †å®ç°(å¸¸é‡æ± ã€é™æ€å˜é‡)**ã€‚
>
> å †ä¸­åŒ…å«æ­£å¸¸å¯¹è±¡å’Œå¸¸é‡æ± ï¼Œnew String()æ”¾å…¥å †ä¸­ï¼ŒString::interä¼šå°†å †ä¸­çš„Stringå˜é‡æ”¾å…¥å †ä¸­çš„å¸¸é‡æ± ä¸­ã€‚



## JAVAçš„ä¸‰ç§å¸¸é‡æ± 

**1. å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆä¹Ÿå«å…¨å±€å­—ç¬¦ä¸²æ± ã€string poolã€string literal poolï¼‰**

**2. è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆruntime constant poolï¼‰**

å½“ç¨‹åºè¿è¡Œåˆ°æŸä¸ªç±»æ—¶ï¼Œclassæ–‡ä»¶ä¸­çš„ä¿¡æ¯å°±ä¼šè¢«è§£æåˆ°å†…å­˜çš„æ–¹æ³•åŒºé‡Œçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªè¿è¡Œæ—¶å¸¸é‡æ± 

**3. classæ–‡ä»¶å¸¸é‡æ± ï¼ˆclass constant poolï¼‰**

classå¸¸é‡æ± æ˜¯åœ¨ç¼–è¯‘åæ¯ä¸ªclassæ–‡ä»¶éƒ½æœ‰çš„ï¼Œclassæ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯å°±æ˜¯ ***å¸¸é‡æ± \****ï¼ˆconstant pool tableï¼‰*ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§å­—é¢é‡ï¼ˆLiteralï¼‰å’Œç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referencesï¼‰ã€‚*å­—é¢é‡å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚

è¿è¡Œæ—¶å¸¸é‡æ± å’Œé™æ€å¸¸é‡æ± å­˜æ”¾åœ¨å…ƒç©ºé—´ä¸­ï¼Œè€Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¾ç„¶å­˜æ”¾åœ¨å †ä¸­ã€‚



## è¯´è¯´åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨çš„å…³ç³»ï¼Ÿ

### :one:  å¤åˆ¶ç®—æ³•

> åŸç†ï¼šå°†å†…å­˜åˆ†æˆä¸¤ä¸ªç›¸ç­‰çš„ä¸¤å°å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ã€‚å½“è¿™ä¸€å—å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†å·²ç»å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ï¼Œç„¶åæŠŠè¿™ä¸€å—å†…å­˜æ¸…ç†æ‰ã€‚
>
> ç¼ºç‚¹ï¼š
>
> > ä¸€æ˜¯ï¼Œå¦‚æœå¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯å­˜æ´»çš„ï¼Œé‚£ä¹ˆå¤åˆ¶ä¼šé€ æˆå¤§é‡çš„å†…å­˜é—´å¤åˆ¶çš„å¼€é”€ã€‚
> >
> > äºŒæ˜¯ï¼Œæ¯æ¬¡åªä½¿ç”¨äº†ä¸€åŠçš„å†…å­˜ç©ºé—´ï¼Œç©ºé—´æµªè´¹æœ‰ç‚¹å¤§ã€‚

### :two: æ ‡è®°-æ¸…é™¤

>æ ‡è®°å‡ºæ‰€æœ‰è¦æ¸…é™¤çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåï¼Œç»Ÿä¸€å›æ”¶æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚
>
>**ç¼ºç‚¹**ï¼š
>
>> ä¸€æ˜¯ï¼Œæ‰§è¡Œæ•ˆç‡ä¸ç¨³å®šï¼Œå¯¼è‡´æ ‡è®°å’Œæ¸…é™¤è¿™ä¸¤ä¸ªåŠ¨ä½œçš„æ‰§è¡Œæ•ˆç‡éšç€å¯¹è±¡æ•°é‡çš„å¢é•¿è€Œé™ä½ã€‚
>>
>> äºŒæ˜¯ï¼Œå†…å­˜ç©ºé—´ä¸è¿ç»­ã€ç¢ç‰‡åŒ–é—®é¢˜ã€‚ç¢ç‰‡ç©ºé—´å¤ªå¤šï¼Œä»¥è‡³äºåé¢è¦ç»™å¤§å¯¹è±¡åˆ†é…å†…å­˜æ—¶æ‰¾ä¸åˆ°è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚

### :three:æ ‡è®°-æ•´ç†

>â€‹	è¿™ä¸ªç®—æ³•æ˜¯é’ˆå¯¹è€å¹´ä»£å›æ”¶æå‡ºæ¥çš„ï¼Œè€å¹´ä»£å¦‚æœä½¿ç”¨å¤åˆ¶ç®—æ³•éœ€è¦è¿›è¡Œè¾ƒå¤šçš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡è¾ƒä½ã€‚ 
>
>â€‹    æ ‡è®°å‡ºæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåå°†å­˜æ´»çš„å¯¹è±¡ç§»åˆ°å†…å­˜ç©ºé—´çš„ä¸€æ®µï¼Œç„¶åç›´æ¥æ¸…ç†ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ç©ºé—´ã€‚

### :four:åˆ†ä»£æ”¶é›†ç†è®º

>Javaè™šæ‹Ÿæœºå°†å †å†…å­˜åˆ†æˆä¸¤å—åŒºåŸŸï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚è¿™æ ·å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹ä½¿ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•ã€‚
>
>**æ–°ç”Ÿä»£**ï¼šæ¯æ¬¡éƒ½æœ‰å¤§é‡çš„å¯¹è±¡æ­»å»ï¼Œé€‰æ‹©å¤åˆ¶ç®—æ³•ï¼Œä»˜å‡ºå¤åˆ¶çš„æˆæœ¬å°±èƒ½å›æ”¶å¤§é‡çš„å¯¹è±¡ã€‚
>
>**è€å¹´ä»£**ï¼šå­˜æ´»çš„å¯¹è±¡æ¯”è¾ƒå¤šï¼Œå¤åˆ¶æ—¶å¼€é”€å¤§ï¼Œé€‰æ‹©æ ‡è®°-æ¸…é™¤ç®—æ³•æˆ–è€…æ ‡è®°-æ•´ç†ç®—æ³•ã€‚



## åƒåœ¾å›æ”¶çš„æ–¹å¼æœ‰å“ªï¼Ÿ

> ## Serial  
>
> > è¿™æ˜¯ä¸€ä¸ªå•çº¿ç¨‹å·¥ä½œçš„æ”¶é›†å™¨ï¼Œå®ƒåœ¨å·¥ä½œæ—¶éœ€è¦åœæ­¢å…¶ä»–æ‰€æœ‰å·¥ä½œï¼Œå°±æ˜¯ä¿—ç§°çš„`stop the word`ã€‚
>
> ## Parallel
>
> >æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ã€‚
>
> > å¤åˆ¶ç®—æ³•çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œå…³æ³¨äºååé‡ã€‚è€å¹´ä»£ï¼ˆParallel Oldï¼‰åŸºäºæ ‡è®°-æ•´ç†ç®—æ³•
>
> ## CMS
>
> > æ˜¯ä¸€ç§ **â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•**å®ç°çš„,æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ã€‚- 
> >
> > >**âœ”ï¸åˆå§‹æ ‡è®°**ï¼š æš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹ï¼Œå¹¶è®°å½•ä¸‹ç›´æ¥ä¸ root ç›¸è¿çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« ï¼›
> > >âœ”ï¸**å¹¶å‘æ ‡è®°**ï¼š åŒæ—¶å¼€å¯ GC å’Œç”¨æˆ·çº¿ç¨‹ï¼Œç”¨ä¸€ä¸ªé—­åŒ…ç»“æ„å»è®°å½•å¯è¾¾å¯¹è±¡ã€‚
> > >**âœ”ï¸é‡æ–°æ ‡è®°**ï¼š ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•
> > >**âœ”ï¸å¹¶å‘æ¸…é™¤**ï¼š å¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶ GC çº¿ç¨‹å¼€å§‹å¯¹æœªæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ã€‚
>
> ## G1
>
> >â€‹	`G1` (Garbage-First) æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨,ä¸»è¦é’ˆå¯¹é…å¤‡å¤šé¢—å¤„ç†å™¨åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ã€‚
> >
> >è¿‡ç¨‹ï¼š
> >
> >>âœ”ï¸**åˆå§‹æ ‡è®°**ï¼šéœ€è¦åœé¡¿çº¿ç¨‹
> >>
> >>âœ”ï¸**å¹¶å‘æ ‡è®°**ï¼šå¯ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œ
> >>
> >>âœ”ï¸**æœ€ç»ˆæ ‡è®°**ï¼šéœ€è¦åœé¡¿çº¿ç¨‹
> >>
> >>âœ”ï¸**ç­›é€‰å›æ”¶**ï¼šå¯ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œ

## ä½ ä»¬é¡¹ç›®çš„åƒåœ¾æ”¶é›†å™¨æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆæŸ¥çœ‹ï¼Ÿ



>```shell
>java -XX:+PrintCommandLineFlags -version
>```



## ä¸ƒå¤§åƒåœ¾æ”¶é›†å™¨



![ ](../images/image-20210721164033823.png)

> ```shell
> -X:+UseSerialGC   
> ```



## å¸¸ç”¨é…æŸ¥é—®é¢˜çš„ä¸€äº›Linuxå‘½ä»¤

```shell
top 
mpstat -P ALL 2
pidstat
free
df
ifstat
```



> vmstat 5 5 #æ¯5ç§’è¿›è¡Œä¸€æ¬¡é‡‡ç”¨ ä¸€å…±é‡‡æ ·5æ¬¡

![](../images/image-20210721175023095.png)

> pidstat   # éœ€è¦å®‰è£…   yum install sysstat

```shell
pidstat -u #å„ä¸ªè¿›ç¨‹cpuä½¿ç”¨ç»Ÿè®¡
pidstat -r #å„ä¸ªè¿›ç¨‹å†…å­˜ä½¿ç”¨ç»Ÿè®¡ 
pidstat -d #å„ä¸ªè¿›ç¨‹IOç»Ÿè®¡
```

> free æ˜¾ç¤ºLinuxç³»ç»Ÿä¸­ç‰©ç†å†…å­˜ã€buffer/cacheã€swapçš„ä½¿ç”¨æƒ…å†µ

```shell
free
```

![image-20210721175936619](../images/image-20210721175936619.png)

> df  ç£ç›˜ç©ºé—´å’Œä½¿ç”¨æƒ…å†µ

```shell
df -h  #ä»¥æ›´æ˜“è¯»çš„æ–¹å¼æ˜¾ç¤ºç›®å‰ç£ç›˜ç©ºé—´å’Œä½¿ç”¨æƒ…å†µ 
```

![image-20210721180129503](../images/image-20210721180129503.png)



> ifstat

```shell
ifstat -a #ç½‘ç»œæµé‡æ¦‚å†µã€‚
```

![image-20210721180456684](../images/image-20210721180456684.png)